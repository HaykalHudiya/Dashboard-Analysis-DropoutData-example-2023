# -*- coding: utf-8 -*-
"""dashboard.py

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1xiulwUH6Kd6KV8sb3s_OTqOl3HvUqXwy
"""

import pandas as pd
import matplotlib.pyplot as plt
import seaborn as sns
import streamlit as st
import json
import folium
from folium import Choropleth
from folium.plugins import HeatMap
from streamlit_folium import st_folium
from babel.numbers import format_currency
# sns.set(style='dark')

def create_filter_prov_df(df):
    filter_prov = df.sort_values(by="PAGU", ascending=True)
    return filter_prov

def display_map(df):
    # Pastikan kolom 'PROVINSI' dalam format yang sesuai dengan GeoJSON
    df['PROVINSI'] = df['PROVINSI'].str.lower()

    # Membuat peta pusat Indonesia
    map = folium.Map(location=[-6.1751, 106.8650], zoom_start=5, scrollWheelZoom=False, tiles='CartoDB positron')
    
    # Buat choropleth dengan warna berdasarkan jumlah sekolah SD
    choropleth = folium.Choropleth(
        geo_data='indonesia-edit.geojson',  # Pastikan file GeoJSON sesuai
        data=df,
        columns=['PROVINSI', 'Jumlah Sekolah SD'],  # Kolom yang digunakan untuk choropleth
        key_on='feature.properties.state',  # Kolom yang digunakan untuk matching
        fill_color='RdYlBu',  # Warna: merah untuk tinggi, biru untuk rendah
        fill_opacity=0.7,
        line_opacity=0.2,
        legend_name="Jumlah Sekolah SD",
        highlight=True
    ).add_to(map)

    # Menambahkan tooltip untuk menampilkan nama provinsi dan jumlah sekolah
    choropleth.geojson.add_child(
        folium.features.GeoJsonTooltip(['name', 'Jumlah Sekolah SD'], labels=False)
    )

    # Menampilkan peta dalam Streamlit
    st_map = st_folium(map, width=700, height=450)
    
    # Mengambil nama provinsi yang dipilih pengguna
    state_name = ''
    if st_map['last_active_drawing']:
        state_name = st_map['last_active_drawing']['properties']['name']
    
    return state_name

# menyiapkan data all_data
all_df = pd.read_csv('data_set_2023.csv')

filter_prov_df = create_filter_prov_df(all_df)

with st.sidebar:
    # Menambahkan logo perusahaan
    st.image("logo_IDE.png")

pd.DataFrame(filter_prov_df)

st.subheader('APBN 2023')

col1, col2 = st.columns(2)

with col1:
    total_provinsi = filter_prov_df['PROVINSI'].count()
    st.metric("Total Provinsi", value=total_provinsi)

with col2:
    total_pagu = filter_prov_df['PAGU'].sum()
    total_pagu_formatted = f"{int(total_pagu / 1e12)} T"
    st.metric("Total PAGU", value=total_pagu_formatted)

plt.figure(figsize=(10, 8))
plt.barh(filter_prov_df['PROVINSI'], filter_prov_df['PAGU'].astype(str).apply(lambda x: x[:-12]),   color=[ "#78B3CE" if pagu == filter_prov_df['PAGU'].max() else "#C9E6F0" for pagu in filter_prov_df['PAGU']])
plt.xlabel('PAGU (Triliun)')
plt.ylabel('Provinsi')
plt.title('Pagu APBN 2023 per Provinsi')
plt.tight_layout()
st.pyplot(plt)

geojson_url = 'indonesia-edit.geojson'

m = folium.Map(location=[-6.1751, 106.8650], zoom_start=5)
all_df['PROVINSI'] = all_df['PROVINSI'].str.lower()

folium.Choropleth(
    geo_data=geojson_url,
    data=all_df,
    columns=['PROVINSI', 'Jumlah Sekolah SD'],
    key_on="feature.properties.state", 
    fill_color="YlGnBu",
    fill_opacity=0.7,
    line_opacity=0.2,
    legend_name="Jumlah Sekolah SD"
)
 
state_name = display_map(all_df)
st.write(f'Provinsi yang dipilih: {state_name}')
